<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S-Patch EX ì¥ê¸° ì‹¤í–‰ í…ŒìŠ¤íŠ¸</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: #f0f2f5;
      color: #1a1a2e;
      min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: #1e3a5f;
      color: white;
      padding: 14px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    header h1 { font-size: 1.15rem; font-weight: 600; letter-spacing: -0.3px; }
    .header-chips { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    /* â”€â”€ Chips â”€â”€ */
    .chip {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 4px 11px; border-radius: 20px;
      font-size: 0.78rem; font-weight: 500; white-space: nowrap;
    }
    .chip-ok    { background: rgba(16,185,129,.18); color: #34d399; border: 1px solid rgba(52,211,153,.3); }
    .chip-err   { background: rgba(239,68,68,.18);  color: #f87171; border: 1px solid rgba(248,113,113,.3); }
    .chip-warn  { background: rgba(245,158,11,.18); color: #fbbf24; border: 1px solid rgba(251,191,36,.3); }
    .chip-blue  { background: rgba(59,130,246,.18); color: #60a5fa; border: 1px solid rgba(96,165,250,.3); }

    /* â”€â”€ Layout â”€â”€ */
    main {
      max-width: 980px;
      margin: 24px auto;
      padding: 0 16px;
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 20px;
      align-items: start;
    }
    @media (max-width: 760px) { main { grid-template-columns: 1fr; } }

    /* â”€â”€ Card â”€â”€ */
    .card {
      background: white;
      border-radius: 14px;
      padding: 22px;
      box-shadow: 0 1px 4px rgba(0,0,0,.07), 0 4px 16px rgba(0,0,0,.04);
    }
    .card-title {
      font-size: .95rem; font-weight: 700; color: #1e3a5f;
      border-bottom: 2px solid #e8f0fe;
      padding-bottom: 10px; margin-bottom: 18px;
    }

    /* â”€â”€ Form fields â”€â”€ */
    .field { margin-bottom: 16px; }
    .field > label {
      display: block; font-size: .82rem; font-weight: 600;
      color: #4b5563; margin-bottom: 6px;
    }
    .field select, .field input[type=text] {
      width: 100%; padding: 9px 12px;
      border: 1.5px solid #d1d5db; border-radius: 9px;
      font-size: .88rem; background: #fafafa; color: #1a1a2e;
      transition: border-color .15s;
    }
    .field select:focus, .field input:focus {
      outline: none; border-color: #3b82f6; background: white;
    }

    /* â”€â”€ Duration toggle buttons â”€â”€ */
    .btn-group { display: flex; gap: 7px; flex-wrap: wrap; }
    .btn-toggle {
      padding: 8px 16px;
      border: 1.5px solid #d1d5db; border-radius: 9px;
      font-size: .83rem; cursor: pointer;
      background: white; color: #555;
      transition: all .15s;
    }
    .btn-toggle:hover { border-color: #3b82f6; color: #3b82f6; }
    .btn-toggle.active {
      background: #2563eb; border-color: #2563eb;
      color: white; font-weight: 600;
    }

    /* â”€â”€ Symptom checkboxes â”€â”€ */
    .symptom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .symptom-label {
      display: flex; align-items: center; gap: 8px;
      padding: 9px 12px;
      border: 1.5px solid #d1d5db; border-radius: 9px;
      cursor: pointer; font-size: .85rem;
      user-select: none; transition: all .15s;
    }
    .symptom-label:hover { border-color: #93c5fd; }
    .symptom-label input[type=checkbox] { display: none; }
    .symptom-label .checkmark {
      width: 16px; height: 16px; border: 2px solid #d1d5db;
      border-radius: 4px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      transition: all .15s;
    }
    .symptom-label.checked { border-color: #3b82f6; background: #eff6ff; color: #1d4ed8; font-weight: 500; }
    .symptom-label.checked .checkmark { background: #2563eb; border-color: #2563eb; }
    .symptom-label.checked .checkmark::after { content: 'âœ“'; color: white; font-size: .7rem; font-weight: 700; }

    /* â”€â”€ Action buttons â”€â”€ */
    .action-row { margin-top: 20px; display: flex; gap: 10px; }
    .btn-primary {
      flex: 1; padding: 13px;
      background: #2563eb; color: white;
      border: none; border-radius: 10px;
      font-size: .95rem; font-weight: 600; cursor: pointer;
      transition: background .15s;
    }
    .btn-primary:hover:not(:disabled) { background: #1d4ed8; }
    .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
    .btn-stop {
      padding: 13px 18px;
      background: white; color: #dc2626;
      border: 1.5px solid #dc2626; border-radius: 10px;
      font-size: .88rem; font-weight: 600; cursor: pointer;
      transition: background .15s;
    }
    .btn-stop:hover { background: #fef2f2; }
    .btn-secondary {
      padding: 7px 14px;
      background: white; color: #2563eb;
      border: 1.5px solid #2563eb; border-radius: 8px;
      font-size: .8rem; font-weight: 500; cursor: pointer;
    }
    .btn-secondary:hover { background: #eff6ff; }

    /* â”€â”€ Progress â”€â”€ */
    #progress-section { margin-bottom: 14px; }
    .progress-bar {
      height: 8px; background: #e5e7eb;
      border-radius: 4px; overflow: hidden; margin: 6px 0 4px;
    }
    .progress-fill {
      height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa);
      border-radius: 4px; transition: width .8s ease;
    }
    .progress-meta {
      display: flex; justify-content: space-between;
      font-size: .76rem; color: #6b7280;
    }

    /* â”€â”€ Next inject box â”€â”€ */
    #next-inject-box {
      background: #eff6ff; border: 1px solid #bfdbfe;
      border-radius: 9px; padding: 10px 14px;
      font-size: .82rem; color: #1d4ed8;
      margin-bottom: 12px;
    }

    /* â”€â”€ Log â”€â”€ */
    .log-wrap {
      border: 1px solid #e5e7eb; border-radius: 10px;
      background: #fafafa; max-height: 520px; overflow-y: auto;
    }
    .log-empty {
      padding: 48px 20px; text-align: center;
      color: #9ca3af; font-size: .88rem;
    }
    .log-item {
      display: grid; grid-template-columns: 62px 1fr;
      gap: 10px; padding: 9px 14px;
      border-bottom: 1px solid #f3f4f6; font-size: .81rem;
    }
    .log-item:last-child { border-bottom: none; }
    .log-time { color: #9ca3af; font-variant-numeric: tabular-nums; padding-top: 1px; }
    .log-item.green  .log-msg { color: #059669; }
    .log-item.red    .log-msg { color: #dc2626; }
    .log-item.blue   .log-msg { color: #2563eb; }
    .log-item.purple .log-msg { color: #7c3aed; }
    .log-item.gray   .log-msg { color: #6b7280; }

    /* â”€â”€ Appium warning banner â”€â”€ */
    #appium-warn {
      background: #fef3c7; border: 1px solid #fcd34d;
      border-radius: 9px; padding: 10px 14px;
      font-size: .82rem; color: #92400e;
      margin-bottom: 14px;
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
  </style>
</head>
<body>

<header>
  <h1>ğŸ©º S-Patch EX ì¥ê¸° ì‹¤í–‰ í…ŒìŠ¤íŠ¸</h1>
  <div class="header-chips">
    <span class="chip chip-warn" id="appium-chip">Appium í™•ì¸ ì¤‘â€¦</span>
    <span class="chip chip-warn" id="run-chip">ëŒ€ê¸° ì¤‘</span>
  </div>
</header>

<main>
  <!-- â”€â”€ Left: Config â”€â”€ -->
  <div>
    <div class="card">
      <div class="card-title">í…ŒìŠ¤íŠ¸ ì„¤ì •</div>

      <!-- Appium warning -->
      <div id="appium-warn" style="display:none">
        âš ï¸ Appium ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
        <button class="btn-secondary" onclick="startAppium()">Appium ì‹œì‘</button>
      </div>

      <!-- Device -->
      <div class="field">
        <label>ì—°ê²°ëœ ë””ë°”ì´ìŠ¤</label>
        <select id="device-select">
          <option value="">ë””ë°”ì´ìŠ¤ í™•ì¸ ì¤‘â€¦</option>
        </select>
      </div>

      <!-- Run name -->
      <div class="field">
        <label>í…ŒìŠ¤íŠ¸ ì´ë¦„ <span style="color:#9ca3af;font-weight:400">(ê²°ê³¼ íŒŒì¼ì— í‘œì‹œë¨)</span></label>
        <input type="text" id="run-name" placeholder="ì˜ˆ: Alice_UAT_Round1" value="uat_run">
      </div>

      <!-- Duration -->
      <div class="field">
        <label>ì¸¡ì • ì‹œê°„</label>
        <div class="btn-group" id="duration-group">
          <button class="btn-toggle" data-val="1">1ì‹œê°„</button>
          <button class="btn-toggle active" data-val="24">24ì‹œê°„</button>
          <button class="btn-toggle" data-val="48">48ì‹œê°„</button>
          <button class="btn-toggle" data-val="72">72ì‹œê°„</button>
        </div>
        <input type="hidden" id="duration-val" value="24">
      </div>

      <!-- Interval -->
      <div class="field">
        <label>ì¦ìƒ ì£¼ì… ê°„ê²©</label>
        <select id="interval-select">
          <option value="1">1ì‹œê°„ë§ˆë‹¤</option>
          <option value="2">2ì‹œê°„ë§ˆë‹¤</option>
          <option value="4" selected>4ì‹œê°„ë§ˆë‹¤</option>
          <option value="8">8ì‹œê°„ë§ˆë‹¤</option>
          <option value="12">12ì‹œê°„ë§ˆë‹¤</option>
        </select>
      </div>

      <!-- Symptoms -->
      <div class="field">
        <label>ì£¼ì…í•  ì¦ìƒ ì„ íƒ</label>
        <div class="symptom-grid" id="symptom-grid">
          <label class="symptom-label checked">
            <input type="checkbox" value="Chest Pain" checked>
            <span class="checkmark"></span>Chest Pain
          </label>
          <label class="symptom-label checked">
            <input type="checkbox" value="Palpitations" checked>
            <span class="checkmark"></span>Palpitations
          </label>
          <label class="symptom-label checked">
            <input type="checkbox" value="Dizziness" checked>
            <span class="checkmark"></span>Dizziness
          </label>
          <label class="symptom-label checked">
            <input type="checkbox" value="Short Breath" checked>
            <span class="checkmark"></span>Short Breath
          </label>
        </div>
      </div>

      <div class="action-row">
        <button class="btn-primary" id="start-btn">â–¶ í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
        <button class="btn-stop" id="stop-btn" style="display:none" onclick="stopTest()">â–  ì¤‘ì§€</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Right: Log â”€â”€ -->
  <div>
    <div class="card">
      <div class="card-title">ì§„í–‰ ìƒí™©</div>

      <!-- Progress bar -->
      <div id="progress-section" style="display:none">
        <div style="font-size:.81rem;color:#6b7280">
          ê²½ê³¼: <strong id="elapsed-text">-</strong> / <span id="total-text">-</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width:0%"></div>
        </div>
        <div class="progress-meta">
          <span id="progress-pct">0%</span>
          <span id="run-name-display" style="color:#9ca3af"></span>
        </div>
      </div>

      <!-- Next inject -->
      <div id="next-inject-box" style="display:none">
        ğŸ• ë‹¤ìŒ ì¦ìƒ ì£¼ì…: <strong id="next-inject-time">-</strong>
      </div>

      <!-- Event log -->
      <div class="log-wrap" id="log-wrap">
        <div class="log-empty" id="log-empty">í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ë©´ ì—¬ê¸°ì— ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>
</main>

<script>
// â”€â”€ Event display config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EVENT_INFO = {
  run_start:                   { text: 'í…ŒìŠ¤íŠ¸ ì‹œì‘',           color: 'blue'   },
  appium_connect:              { text: 'Appium ì—°ê²°ë¨',          color: 'blue'   },
  ensure_measurement_started:  { text: 'ì¸¡ì • ìƒíƒœ í™•ì¸ ì¤‘â€¦',     color: 'gray'   },
  measurement_already_running: { text: 'ì¸¡ì • ì´ë¯¸ ì§„í–‰ ì¤‘ âœ“',   color: 'green'  },
  measurement_confirmed_running:{ text: 'ì¸¡ì • ì§„í–‰ ì¤‘ í™•ì¸ë¨ âœ“',color: 'green'  },
  measurement_started:         { text: 'ì¸¡ì • ì‹œì‘ë¨ âœ“',         color: 'green'  },
  tapping_start_now:           { text: 'Start Now íƒ­',           color: 'gray'   },
  offline_mode_detected:       { text: 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ ê°ì§€ë¨',   color: 'gray'   },
  inject_symptom_start:        { text: null,                     color: 'purple' },
  inject_symptom_done:         { text: null,                     color: 'green'  },
  inject_symptom_failed:       { text: 'ì¦ìƒ ì£¼ì… ì‹¤íŒ¨ âœ—',      color: 'red'    },
  schedule_add:                { text: null,                     color: 'gray'   },
  session_check_failed:        { text: 'ì„¸ì…˜ ì˜¤ë¥˜ âš ï¸',           color: 'red'    },
  run_complete:                { text: 'í…ŒìŠ¤íŠ¸ ì™„ë£Œ ğŸ‰',         color: 'green'  },
  run_failed:                  { text: null,                     color: 'red'    },
};

function fmtEvent(ev) {
  const info = EVENT_INFO[ev.event] || { text: ev.event, color: 'gray' };
  let text = info.text;

  if (ev.event === 'inject_symptom_start') {
    const s = (ev.data?.symptoms || []).join(', ');
    text = `ì¦ìƒ ì£¼ì… ì‹œì‘: ${s}`;
  } else if (ev.event === 'inject_symptom_done') {
    const sec = ev.data?.elapsed_sec ?? '?';
    text = `ì¦ìƒ ì£¼ì… ì™„ë£Œ âœ“  (${sec}ì´ˆ)`;
  } else if (ev.event === 'schedule_add') {
    const d = ev.data || {};
    const t = d.run_at ? new Date(d.run_at).toLocaleTimeString('ko-KR') : '-';
    text = `ë‹¤ìŒ ì£¼ì… ì˜ˆì•½ â†’ ${t}`;
  } else if (ev.event === 'run_failed') {
    text = `í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ âœ—  â€” ${ev.data?.error || ''}`;
  }
  return { text: text || ev.event, color: info.color };
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pollTimer   = null;
let seenEvents  = 0;
let runStartTs  = null;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  // Load devices + appium status
  const r = await fetch('/api/init').then(r => r.json());
  updateAppiumUI(r.appium);
  populateDevices(r.devices);

  // Restore running state if process was already going
  const s = await fetch('/api/status').then(r => r.json());
  if (s.events.length > 0) {
    renderLog(s.events, true);
    updateProgress(s.events);
    updateNextInject(s.events);
  }
  if (s.running) {
    setUIRunning(true);
    startPolling();
  } else if (s.exit_code !== null && s.exit_code !== undefined) {
    showFinished(s.exit_code);
  }
}

function updateAppiumUI(ok) {
  const chip = document.getElementById('appium-chip');
  chip.className = 'chip ' + (ok ? 'chip-ok' : 'chip-err');
  chip.textContent  = ok ? 'âœ“ Appium ì—°ê²°ë¨' : 'âœ— Appium ì—†ìŒ';
  document.getElementById('appium-warn').style.display = ok ? 'none' : 'flex';
}

function populateDevices(devices) {
  const sel = document.getElementById('device-select');
  sel.innerHTML = '';
  if (!devices.length) {
    sel.innerHTML = '<option value="">ì—°ê²°ëœ ë””ë°”ì´ìŠ¤ ì—†ìŒ</option>';
  } else {
    devices.forEach(d => {
      const o = document.createElement('option');
      o.value = o.textContent = d;
      sel.appendChild(o);
    });
  }
}

// â”€â”€ Duration toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('duration-group').addEventListener('click', e => {
  const btn = e.target.closest('.btn-toggle');
  if (!btn) return;
  document.querySelectorAll('#duration-group .btn-toggle').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('duration-val').value = btn.dataset.val;
});

// â”€â”€ Symptom toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('symptom-grid').addEventListener('click', e => {
  const lbl = e.target.closest('.symptom-label');
  if (!lbl) return;
  const cb = lbl.querySelector('input');
  cb.checked = !cb.checked;
  lbl.classList.toggle('checked', cb.checked);
});

// â”€â”€ Appium start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startAppium() {
  const btn = document.querySelector('#appium-warn button');
  btn.textContent = 'ì‹œì‘ ì¤‘â€¦'; btn.disabled = true;
  const r = await fetch('/api/appium/start', { method: 'POST' }).then(r => r.json());
  btn.textContent = 'Appium ì‹œì‘'; btn.disabled = false;
  if (r.error) { alert(r.error); return; }
  updateAppiumUI(r.running);
}

// â”€â”€ Start test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('start-btn').addEventListener('click', async () => {
  const device = document.getElementById('device-select').value;
  if (!device) { alert('ì—°ê²°ëœ ë””ë°”ì´ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

  const symptoms = [...document.querySelectorAll('#symptom-grid input:checked')].map(c => c.value);
  if (!symptoms.length) { alert('ì¦ìƒì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

  const body = {
    device,
    run_name:       document.getElementById('run-name').value || 'uat_run',
    duration_hours: parseInt(document.getElementById('duration-val').value),
    interval_hours: parseFloat(document.getElementById('interval-select').value),
    symptoms,
  };

  const r = await fetch('/api/start', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  }).then(r => r.json());

  if (r.error) { alert(r.error); return; }

  seenEvents  = 0;
  runStartTs  = null;
  document.getElementById('log-wrap').innerHTML =
    '<div class="log-empty" id="log-empty">ë¡œê·¸ ëŒ€ê¸° ì¤‘â€¦</div>';
  document.getElementById('progress-section').style.display = 'none';
  document.getElementById('next-inject-box').style.display  = 'none';

  setUIRunning(true);
  startPolling();
});

// â”€â”€ Stop test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function stopTest() {
  if (!confirm('í…ŒìŠ¤íŠ¸ë¥¼ ì¤‘ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await fetch('/api/stop', { method: 'POST' });
  stopPolling();
  setUIRunning(false);
  const chip = document.getElementById('run-chip');
  chip.className = 'chip chip-warn'; chip.textContent = 'ì¤‘ì§€ë¨';
}

// â”€â”€ UI state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setUIRunning(running) {
  document.getElementById('start-btn').disabled = running;
  document.getElementById('stop-btn').style.display = running ? '' : 'none';
  const chip = document.getElementById('run-chip');
  chip.className = 'chip ' + (running ? 'chip-blue' : 'chip-warn');
  chip.textContent = running ? 'â— ì‹¤í–‰ ì¤‘' : 'ëŒ€ê¸° ì¤‘';
}

function showFinished(code) {
  const chip = document.getElementById('run-chip');
  chip.className = 'chip ' + (code === 0 ? 'chip-ok' : 'chip-err');
  chip.textContent = code === 0 ? 'ì™„ë£Œ âœ“' : 'ì‹¤íŒ¨ âœ—';
}

// â”€â”€ Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startPolling() {
  if (pollTimer) clearInterval(pollTimer);
  poll();
  pollTimer = setInterval(poll, 2000);
}
function stopPolling() {
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}

async function poll() {
  let s;
  try { s = await fetch('/api/status').then(r => r.json()); }
  catch { return; }

  renderLog(s.events);
  updateProgress(s.events);
  updateNextInject(s.events);

  if (!s.running && pollTimer) {
    stopPolling();
    setUIRunning(false);
    showFinished(s.exit_code ?? -1);
  }
}

// â”€â”€ Log rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLog(events, reset = false) {
  if (!events?.length) return;
  const wrap  = document.getElementById('log-wrap');
  const empty = document.getElementById('log-empty');

  if (reset) { wrap.innerHTML = ''; seenEvents = 0; }

  if (events.length > seenEvents) {
    if (seenEvents === 0) wrap.innerHTML = '';

    for (let i = seenEvents; i < events.length; i++) {
      const ev = events[i];
      const { text, color } = fmtEvent(ev);
      const time = ev.ts ? ev.ts.split('T')[1].slice(0, 8) : '';

      const div = document.createElement('div');
      div.className = `log-item ${color}`;
      div.innerHTML = `<span class="log-time">${time}</span><span class="log-msg">${text}</span>`;
      wrap.appendChild(div);
    }
    seenEvents = events.length;
    wrap.scrollTop = wrap.scrollHeight;
  }
}

// â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateProgress(events) {
  const startEv = events?.find(e => e.event === 'run_start');
  if (!startEv) return;

  document.getElementById('progress-section').style.display = '';

  const tH = startEv.data?.duration_hours || 24;
  if (!runStartTs) runStartTs = new Date(startEv.ts);

  const elapsedMs = Date.now() - runStartTs.getTime();
  const pct       = Math.min(100, (elapsedMs / (tH * 3_600_000)) * 100);
  const elH = Math.floor(elapsedMs / 3_600_000);
  const elM = Math.floor((elapsedMs % 3_600_000) / 60_000);

  document.getElementById('progress-fill').style.width = pct.toFixed(1) + '%';
  document.getElementById('progress-pct').textContent  = pct.toFixed(1) + '%';
  document.getElementById('elapsed-text').textContent  = `${elH}ì‹œê°„ ${elM}ë¶„`;
  document.getElementById('total-text').textContent    = `${tH}ì‹œê°„`;
  document.getElementById('run-name-display').textContent =
    document.getElementById('run-name').value || '';
}

// â”€â”€ Next inject â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateNextInject(events) {
  const box  = document.getElementById('next-inject-box');
  const time = document.getElementById('next-inject-time');

  let runAt = null;
  for (let i = (events?.length ?? 0) - 1; i >= 0; i--) {
    const ev = events[i];
    if (ev.event === 'schedule_add' && ev.data?.run_at) {
      runAt = ev.data.run_at; break;
    }
  }

  if (runAt && new Date(runAt) > new Date()) {
    box.style.display = '';
    time.textContent  = new Date(runAt).toLocaleTimeString('ko-KR');
  } else {
    box.style.display = 'none';
  }
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
